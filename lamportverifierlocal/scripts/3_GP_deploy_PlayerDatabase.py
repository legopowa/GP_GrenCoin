import lorem

import sys
from itertools import chain
import random
import hashlib
import base64
from web3 import Web3
from web3.exceptions import InvalidAddress
from brownie import network, web3, accounts, Wei, AnonIDContract, LamportBase2, Contract
from brownie.network import gas_price
from brownie.network.gas.strategies import LinearScalingStrategy
from eth_utils import encode_hex #, encode
from eth_abi import encode, encode
from Crypto.Hash import keccak
from typing import List
import json
import os
import ast
import time
from time import sleep
import re
from typing import List
import struct
from offchain.local_functions import get_pkh_list
from offchain.KeyTracker_ import KeyTracker
from offchain.soliditypack import solidity_pack_value_bytes, solidity_pack_value, pack_keys, encode_packed_2d_list, solidity_pack_bytes, encode_packed, solidity_pack_pairs, solidity_pack, solidity_pack_bytes, solidity_pack_array
from offchain.Types import LamportKeyPair, Sig, PubPair
from offchain.functions import hash_b, sign_hash, verify_signed_hash
from eth_abi import encode#, encode
from binascii import crc32, hexlify
import binascii
from offchain.crc import compute_crc
#from offchain.oracle_functions import extract_data_from_file, get_pkh_list, send_pkh_with_crc, save_received_data, read_till_eof, send_packed_file
import offchain.data_temp

SOF = b'\x01'  # Start Of File marker
EOF = b'\x04'  # End Of File marker
CRC_START = b'<CRC>'
CRC_END = b'</CRC>'



gas_strategy = LinearScalingStrategy("120 gwei", "1200 gwei", 1.1)

# if network.show_active() == "development":
gas_price(gas_strategy)

# ITERATIONS = 3

# def compute_crc(self, data: str) -> int:
#     return crc32(data.encode())

offchain.data_temp.received_data = b''

def encode_packed(*args):
    return b"".join([struct.pack(f"<{len(arg)}s", arg) for arg in args])


def custom_encode_packed(address, integer):
    # Convert the address to bytes and pad with zeroes
    address_bytes = bytes(Web3.toBytes(hexstr=address))

    # Convert the integer to bytes and pad with zeroes
    integer_bytes = encode('uint', integer)

    # Concatenate everything together
    result = address_bytes + b'\0' * 12 + integer_bytes + b'\0' * 12

    return result.decode('unicode_escape')

def main():
    for _ in range(1):  # This will repeat the whole logic 3 times
        lamport_test = LamportTest()
        
        # Convert all account objects to strings before passing them
        lamport_test.can_test_key_functions([str(acc) for acc in accounts])


oracle_pkh = []
master_pkh_1 = []
master_pkh_2 = []
master_pkh_3 = []
master_pkh_4 = []
arg1 = "GPGrens"
arg2 = "GPG"

# ABI encode the arguments
encoded_args = encode(['string', 'string'], [arg1, arg2])

# Load the bytecode of the contract (replace with actual bytecode)
full_bytecode = "0x60c0604052600360809081526254464360e81b60a05260079062000024908262000128565b50601180546001600160a01b03191673b3830ae69ee5962355e84f6bbac274ff337960e51790553480156200005857600080fd5b50601154600f80546001600160a01b0319166001600160a01b03909216919091179055620001f4565b634e487b7160e01b600052604160045260246000fd5b600181811c90821680620000ac57607f821691505b602082108103620000cd57634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111562000123576000816000526020600020601f850160051c81016020861015620000fe5750805b601f850160051c820191505b818110156200011f578281556001016200010a565b5050505b505050565b81516001600160401b0381111562000144576200014462000081565b6200015c8162000155845462000097565b84620000d3565b602080601f8311600181146200019457600084156200017b5750858301515b600019600386901b1c1916600185901b1785556200011f565b600085815260208120601f198616915b82811015620001c557888601518255948401946001909101908401620001a4565b5085821015620001e45787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b613c2080620002046000396000f3fe608060405234801561001057600080fd5b50600436106102485760003560e01c80638098dcff1161013b578063bb517946116100b8578063e9fc174e1161007c578063e9fc174e1461063e578063f107f87714610651578063f34c9fbe14610664578063fa6f393614610677578063facd743b146106a957600080fd5b8063bb517946146105a1578063c3c5a547146105b4578063d90afa2b146105e0578063da76a700146105f3578063dd62ed3e1461061357600080fd5b8063ac2c34ef116100ff578063ac2c34ef1461054d578063ac4bcd0114610560578063aca2490b14610568578063aeb15a6d1461057b578063bac7e0321461058e57600080fd5b80638098dcff146104bf57806385d8f13d146104d4578063862dfd3e146104f4578063910fcd5a1461050757806395df06401461051a57600080fd5b806334a88c5b116101c9578063573088da1161018d578063573088da146103e25780635889fb34146104175780635d3f33961461042a57806370a082311461045e5780637f97ecc31461048c57600080fd5b806334a88c5b1461032a57806338a0b5c6146103525780633fe7829f14610390578063424aeded146103a357806356bf7b57146103cf57600080fd5b80631ccee0cc116102105780631ccee0cc146102cb57806325aacfa3146102de578063285edaa6146102f15780632b864feb1461030457806330a3db7e1461031757600080fd5b806302b8c2611461024d57806307fd3bbf1461026257806312243b671461027557806315c6aee2146102885780631881f255146102b8575b600080fd5b61026061025b366004612f61565b6106da565b005b610260610270366004612fbc565b610786565b610260610283366004613029565b6108d1565b61029b61029636600461304b565b610aae565b6040516001600160a01b0390911681526020015b60405180910390f35b6102606102c6366004613064565b610ad8565b6102606102d9366004612fbc565b610b63565b6102606102ec366004612fbc565b610dba565b6102606102ff366004612f61565b610f05565b610260610312366004612fbc565b610fae565b610260610325366004613145565b611104565b61033d610338366004613029565b611599565b604080519283526020830191909152016102af565b6103806103603660046131dc565b805160208183018101805160008252928201919093012091525460ff1681565b60405190151581526020016102af565b600d5461029b906001600160a01b031681565b6103b66103b1366004613029565b61162b565b6040516102af9d9c9b9a99989796959493929190613269565b600f5461029b906001600160a01b031681565b6103806103f0366004613029565b6001600160a01b031660009081526009602052604090205465010000000000900460ff1690565b610260610425366004612f61565b6117c3565b610380610438366004613029565b6001600160a01b0316600090815260096020526040902054640100000000900460ff1690565b61047e61046c366004613029565b60016020526000908152604090205481565b6040519081526020016102af565b61038061049a366004613029565b6001600160a01b0316600090815260096020526040902054600160301b900460ff1690565b6104c761185b565b6040516102af9190613307565b6104e76104e236600461336b565b6119b9565b6040516102af9190613434565b600c5461029b906001600160a01b031681565b610260610515366004613481565b611e6a565b610380610528366004613029565b6001600160a01b03166000908152600960205260409020546301000000900460ff1690565b61026061055b366004612f61565b6121dc565b6104c7612282565b610260610576366004612f61565b61235b565b610260610589366004612fbc565b6123fa565b61026061059c366004612fbc565b612647565b600e5461029b906001600160a01b031681565b6103806105c2366004613029565b6001600160a01b031660009081526009602052604090205460ff1690565b6102606105ee366004612fbc565b61289c565b61060661060136600461304b565b612991565b6040516102af9190613517565b61047e61062136600461352a565b600260209081526000928352604080842090915290825290205481565b61026061064c366004612f61565b612a3d565b600b5461029b906001600160a01b031681565b610260610672366004612fbc565b612af2565b610380610685366004613029565b6001600160a01b031660009081526009602052604090205462010000900460ff1690565b6103806106b7366004613029565b6001600160a01b0316600090815260096020526040902054610100900460ff1690565b600d546001600160a01b0316331461074d5760405162461bcd60e51b81526020600482015260396024820152600080516020613bcb83398151915260448201527f6e6765204f6e626f61726420517565756572207374617475730000000000000060648201526084015b60405180910390fd5b6001600160a01b0390911660009081526009602052604090208054911515650100000000000265ff000000000019909216919091179055565b600081604051602001610799919061355d565b60408051601f1981840301815290829052600f5463333f611160e01b83529092506000916001600160a01b039091169063333f6111906107e39089908990899088906004016135a3565b6020604051808303816000875af1158015610802573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108269190613684565b90508061089b5760405162461bcd60e51b815260206004820152603960248201527f417574686f72697a6174696f6e206661696c656420666f72207570646174696e60448201527f67204f6e72616d7020636f6e74726163742061646472657373000000000000006064820152608401610744565b505033600090815260056020526040902080546001600160a01b0319166001600160a01b03929092169190911790556010555050565b600d546001600160a01b0316331461093f5760405162461bcd60e51b815260206004820152602b60248201527f4f6e6c7920746865206f6e72616d7020636f6e74726163742063616e2064656c60448201526a65746520706c617965727360a81b6064820152608401610744565b6001600160a01b0381166000908152600960205260408120805466ffffffffffffff19168155906109736001830182612ee1565b600282016000905560038201600061098b9190612ee1565b506004810180546001600160a01b031916905560006005820181905560069091018190555b600a54811015610aaa57816001600160a01b0316600a82815481106109d7576109d76136a1565b6000918252602090912001546001600160a01b031603610aa257600a8054610a01906001906136b7565b81548110610a1157610a116136a1565b600091825260209091200154600a80546001600160a01b039092169183908110610a3d57610a3d6136a1565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550600a805480610a7c57610a7c6136d8565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b6001016109b0565b5050565b600a8181548110610abe57600080fd5b6000918252602090912001546001600160a01b0316905081565b600e546001600160a01b03163314610b445760405162461bcd60e51b815260206004820152602960248201527f4f6e6c792074686520666f72756d20636f6e74726163742063616e2073657420604482015268666f72756d206b657960b81b6064820152608401610744565b6001600160a01b03909116600090815260096020526040902060020155565b600081604051602001610b76919061355d565b60408051808303601f19018152918152336000908152600560205220549091506001600160a01b03838116911614610c005760405162461bcd60e51b815260206004820152602760248201527f4f6e72616d7020636f6e7472616374206164647265737320757064617465206d6044820152660d2e6dac2e8c6d60cb1b6064820152608401610744565b600085604051602001610c1391906136ee565b6040516020818303038152906040528051906020012090508060105403610c4c5760405162461bcd60e51b815260040161074490613725565b600f5460405163333f611160e01b81526000916001600160a01b03169063333f611190610c83908a908a908a9089906004016135a3565b6020604051808303816000875af1158015610ca2573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610cc69190613684565b905080610d4a5760405162461bcd60e51b815260206004820152604660248201527f417574686f72697a6174696f6e206661696c6564206f6e20636f6e6669726d6160448201527f74696f6e206f66204f6e72616d7020636f6e747261637420616464726573732060648201526575706461746560d01b608482015260a401610744565b600d80546001600160a01b0319166001600160a01b0386169081179091556040517f5959e7554218adbe3edb157f744a698c903698e2be92d199d2938afb8b0312ab90600090a2505033600090815260056020526040812080546001600160a01b03191690556010555050505050565b600081604051602001610dcd919061355d565b60408051601f1981840301815290829052600f5463333f611160e01b83529092506000916001600160a01b039091169063333f611190610e179089908990899088906004016135a3565b6020604051808303816000875af1158015610e36573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610e5a9190613684565b905080610ecf5760405162461bcd60e51b815260206004820152603a60248201527f417574686f72697a6174696f6e206661696c656420666f722070726f706f736560448201527f642047616d6556616c20636f6e747261637420616464726573730000000000006064820152608401610744565b505033600090815260046020526040902080546001600160a01b0319166001600160a01b03929092169190911790556010555050565b600e546001600160a01b03163314610f7b5760405162461bcd60e51b815260206004820152603360248201527f4f6e6c792074686520666f72756d20636f6e74726163742063616e206d6f64696044820152726679206d6f64657261746f722073746174757360681b6064820152608401610744565b6001600160a01b0390911660009081526009602052604090208054911515620100000262ff000019909216919091179055565b600081604051602001610fc1919061355d565b60408051601f1981840301815290829052600f5463333f611160e01b83529092506000916001600160a01b039091169063333f61119061100b9089908990899088906004016135a3565b6020604051808303816000875af115801561102a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061104e9190613684565b9050806110ce5760405162461bcd60e51b815260206004820152604260248201527f417574686f72697a6174696f6e206661696c656420666f722070726f706f736560448201527f6420757064617465206f6620466f72756d20636f6e7472616374206164647265606482015261737360f01b608482015260a401610744565b505033600090815260066020526040902080546001600160a01b0319166001600160a01b03929092169190911790556010555050565b600d546001600160a01b031633146111765760405162461bcd60e51b815260206004820152602f60248201527f4f6e6c7920746865206f6e72616d7020636f6e74726163742063616e2061646460448201526e2f75706461746520706c617965727360881b6064820152608401610744565b600c54604051633af32abf60e01b81526001600160a01b03888116600483015290911690633af32abf90602401602060405180830381865afa1580156111c0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906111e49190613684565b61123a5760405162461bcd60e51b815260206004820152602160248201527f41646472657373206e6f742077686974656c697374656420696e20416e6f6e496044820152601160fa1b6064820152608401610744565b6001600160a01b0386166000908152600960205260409020805460ff16156112ea576003810161126a8782613811565b50600181016112798682613811565b506001600160a01b038216156112ab576004810180546001600160a01b0319166001600160a01b0384161790556112c9565b6004810180546001600160a01b0319166001600160a01b0389161790555b83156112d757600581018490555b82156112e557600681018390555b611590565b831515806112f757508215155b61135b5760405162461bcd60e51b815260206004820152602f60248201527f4f7261636c65206b657920696e6465782063616e6e6f74206265207a65726f2060448201526e666f72206e657720706c617965727360881b6064820152608401610744565b604051806101a001604052806001151581526020016000151581526020016000151581526020016000151581526020016000151581526020016000151581526020016000151581526020018681526020016000801b8152602001878152602001886001600160a01b031681526020018581526020018481525060096000896001600160a01b03166001600160a01b0316815260200190815260200160002060008201518160000160006101000a81548160ff02191690831515021790555060208201518160000160016101000a81548160ff02191690831515021790555060408201518160000160026101000a81548160ff02191690831515021790555060608201518160000160036101000a81548160ff02191690831515021790555060808201518160000160046101000a81548160ff02191690831515021790555060a08201518160000160056101000a81548160ff02191690831515021790555060c08201518160000160066101000a81548160ff02191690831515021790555060e08201518160010190816114ee9190613811565b506101008201516002820155610120820151600382019061150f9082613811565b506101408201516004820180546001600160a01b03199081166001600160a01b0393841617909155610160840151600584015561018090930151600690920191909155600a80546001810182556000919091527fc65a7bb8d6351c1cf70c95a316cc6a92839c986682d98bc35f958f4883f9d2a80180549092169089161790555b50505050505050565b6001600160a01b038116600090815260096020526040812054819060ff166116035760405162461bcd60e51b815260206004820152601860248201527f506c61796572206973206e6f74207265676973746572656400000000000000006044820152606401610744565b50506001600160a01b0316600090815260096020526040902060058101546006909101549091565b6009602052600090815260409020805460018201805460ff808416946101008504821694620100008104831694630100000082048416946401000000008304851694650100000000008404811694600160301b9094041692919061168e9061378c565b80601f01602080910402602001604051908101604052809291908181526020018280546116ba9061378c565b80156117075780601f106116dc57610100808354040283529160200191611707565b820191906000526020600020905b8154815290600101906020018083116116ea57829003601f168201915b5050505050908060020154908060030180546117229061378c565b80601f016020809104026020016040519081016040528092919081815260200182805461174e9061378c565b801561179b5780601f106117705761010080835404028352916020019161179b565b820191906000526020600020905b81548152906001019060200180831161177e57829003601f168201915b505050506004830154600584015460069094015492936001600160a01b03909116929091508d565b600d546001600160a01b031633146118245760405162461bcd60e51b81526020600482015260306024820152600080516020613bcb83398151915260448201526f6e67652041646d696e2073746174757360801b6064820152608401610744565b6001600160a01b03909116600090815260096020526040902080549115156401000000000264ff0000000019909216919091179055565b600a5460609060009067ffffffffffffffff81111561187c5761187c61308e565b6040519080825280602002602001820160405280156118af57816020015b606081526020019060019003908161189a5790505b50905060005b600a548110156119b357600060096000600a84815481106118d8576118d86136a1565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001810180549192509061190f9061378c565b80601f016020809104026020016040519081016040528092919081815260200182805461193b9061378c565b80156119885780601f1061195d57610100808354040283529160200191611988565b820191906000526020600020905b81548152906001019060200180831161196b57829003601f168201915b505050505083838151811061199f5761199f6136a1565b6020908102919091010152506001016118b5565b50919050565b600b546060906001600160a01b03163314611a345760405162461bcd60e51b815260206004820152603560248201527f4f6e6c79207468652067616d652076616c696461746f7220636f6e74726163746044820152740818d85b881858d8d95cdcc81d1a1a5cc81b1a5cdd605a1b6064820152608401610744565b6000835167ffffffffffffffff811115611a5057611a5061308e565b604051908082528060200260200182016040528015611a79578160200160208202803683370190505b50905060005b8451811015611e605760005b600a54811015611e5757858281518110611aa757611aa76136a1565b6020026020010151604051602001611abf91906138d1565b6040516020818303038152906040528051906020012060096000600a8481548110611aec57611aec6136a1565b60009182526020808320909101546001600160a01b0316835282810193909352604091820190209051611b269260019290920191016138ed565b6040516020818303038152906040528051906020012003611e4f57600c54600a80546000926001600160a01b031691635a725b07916007919086908110611b6f57611b6f6136a1565b6000918252602090912001546040516001600160e01b031960e085901b168152611ba692916001600160a01b0316906004016139e0565b602060405180830381865afa158015611bc3573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611be79190613a0a565b90508060ff16600203611da85760096000600a8481548110611c0b57611c0b6136a1565b60009182526020808320909101546001600160a01b0390811684529083019390935260409091019020600401548551911690859085908110611c4f57611c4f6136a1565b6001600160a01b03909216602092830291909101909101526000611c74603c88613a2d565b600c54600a80549293506001600160a01b039091169163d47b2e99919086908110611ca157611ca16136a1565b60009182526020909120015460405160e083901b6001600160e01b03191681526001600160a01b03909116600482015260248101849052604401600060405180830381600087803b158015611cf557600080fd5b505af1158015611d09573d6000803e3d6000fd5b5050600c54600a80546001600160a01b039092169350632eb4b54f92509086908110611d3757611d376136a1565b6000918252602090912001546040516001600160e01b031960e084901b168152611d70916001600160a01b031690600790600401613a4f565b600060405180830381600087803b158015611d8a57600080fd5b505af1158015611d9e573d6000803e3d6000fd5b5050505050611e49565b8060ff16600003611e4957600c54600a80546001600160a01b0390921691632eb4b54f919085908110611ddd57611ddd6136a1565b6000918252602090912001546040516001600160e01b031960e084901b168152611e16916001600160a01b031690600790600401613a4f565b600060405180830381600087803b158015611e3057600080fd5b505af1158015611e44573d6000803e3d6000fd5b505050505b50611e57565b600101611a8b565b50600101611a7f565b5090505b92915050565b600083604051602001611e7d91906136ee565b60408051808303601f19018152908290528051602090910120600f5463b9d57c5f60e01b8352600483018290529092506000916001600160a01b039091169063b9d57c5f90602401606060405180830381865afa158015611ee2573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611f069190613a73565b92505050600080611f1633611599565b9150915081831480611f2757508083145b611f845760405162461bcd60e51b815260206004820152602860248201527f43616c6c65722773206f7261636c65206b657920696e64657820646f6573206e6044820152670dee840dac2e8c6d60c31b6064820152608401610744565b33600090815260096020526040902054640100000000900460ff16611feb5760405162461bcd60e51b815260206004820152601a60248201527f43616c6c6572206973206e6f7420612067616d652061646d696e0000000000006044820152606401610744565b600f5460408051603160f81b6020820152815160018183030181526021820192839052634a89d52b60e01b9092526001600160a01b0390921691634a89d52b9161203e918b918b918b91906025016135a3565b6020604051808303816000875af115801561205d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906120819190613684565b6120cd5760405162461bcd60e51b815260206004820152601b60248201527f4c616d706f7274206f7261636c6520636865636b206661696c656400000000006044820152606401610744565b871561216f576000896040516120e391906138d1565b9081526040519081900360200190205460ff1661216a57600160008a60405161210c91906138d1565b908152604051908190036020019020805491151560ff19909216919091179055600880546001810182556000919091527ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee3016121688a82613811565b505b6121d1565b60008960405161217f91906138d1565b9081526040519081900360200190205460ff16156121d1576000808a6040516121a891906138d1565b908152604051908190036020019020805491151560ff199092169190911790556121d189612d3e565b505050505050505050565b600d546001600160a01b0316331461224a5760405162461bcd60e51b815260206004820152603c6024820152600080516020613bcb83398151915260448201527f6e6765204f6e626f6172642052656769737472617220537461747573000000006064820152608401610744565b6001600160a01b0390911660009081526009602052604090208054911515600160301b0266ff00000000000019909216919091179055565b60606008805480602002602001604051908101604052809291908181526020016000905b828210156123525783829060005260206000200180546122c59061378c565b80601f01602080910402602001604051908101604052809291908181526020018280546122f19061378c565b801561233e5780601f106123135761010080835404028352916020019161233e565b820191906000526020600020905b81548152906001019060200180831161232157829003601f168201915b5050505050815260200190600101906122a6565b50505050905090565b600d546001600160a01b031633146123c95760405162461bcd60e51b81526020600482015260396024820152600080516020613bcb83398151915260448201527f6e67652047616d652056616c696461746f7220737461747573000000000000006064820152608401610744565b6001600160a01b03909116600090815260096020526040902080549115156101000261ff0019909216919091179055565b60008160405160200161240d919061355d565b60408051808303601f19018152918152336000908152600460205220549091506001600160a01b0383811691161461249a5760405162461bcd60e51b815260206004820152602a60248201527f50726f706f7365642047616d6556616c20636f6e7472616374206164647265736044820152690e640dad2e6dac2e8c6d60b31b6064820152608401610744565b6000856040516020016124ad91906136ee565b60405160208183030381529060405280519060200120905080601054036124e65760405162461bcd60e51b815260040161074490613725565b600f5460405163333f611160e01b81526000916001600160a01b03169063333f61119061251d908a908a908a9089906004016135a3565b6020604051808303816000875af115801561253c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906125609190613684565b9050806125d7576040805162461bcd60e51b81526020600482015260248101919091527f417574686f72697a6174696f6e206661696c6564206f6e20636f6e6669726d6160448201527f74696f6e206f662047616d6556616c20636f6e747261637420616464726573736064820152608401610744565b600b80546001600160a01b0319166001600160a01b0386169081179091556040517f6f1895f9314e8b91a7a1c3a67319510d05c9d6729515f83cc2eaca70d3e81f8790600090a2505033600090815260046020526040812080546001600160a01b03191690556010555050505050565b60008160405160200161265a919061355d565b60408051808303601f19018152918152336000908152600660205220549091506001600160a01b038381169116146126e35760405162461bcd60e51b815260206004820152602660248201527f466f72756d20636f6e7472616374206164647265737320757064617465206d696044820152650e6dac2e8c6d60d31b6064820152608401610744565b6000856040516020016126f691906136ee565b604051602081830303815290604052805190602001209050806010540361272f5760405162461bcd60e51b815260040161074490613725565b600f5460405163333f611160e01b81526000916001600160a01b03169063333f611190612766908a908a908a9089906004016135a3565b6020604051808303816000875af1158015612785573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906127a99190613684565b90508061282c5760405162461bcd60e51b815260206004820152604560248201527f417574686f72697a6174696f6e206661696c6564206f6e20636f6e6669726d6160448201527f74696f6e206f6620466f72756d20636f6e747261637420616464726573732075606482015264706461746560d81b608482015260a401610744565b600e80546001600160a01b0319166001600160a01b0386169081179091556040517f78e5262e53e14d17b3058c6b8cf7cd3c2fb92a4172fa393fddd75cb57523b1c690600090a2505033600090815260066020526040812080546001600160a01b03191690556010555050505050565b6000816040516020016128af919061355d565b60408051601f1981840301815290829052600f5463333f611160e01b83529092506000916001600160a01b039091169063333f6111906128f99089908990899088906004016135a3565b6020604051808303816000875af1158015612918573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061293c9190613684565b90508061295b5760405162461bcd60e51b815260040161074490613aae565b505033600090815260036020526040902080546001600160a01b0319166001600160a01b03929092169190911790556010555050565b600881815481106129a157600080fd5b9060005260206000200160009150905080546129bc9061378c565b80601f01602080910402602001604051908101604052809291908181526020018280546129e89061378c565b8015612a355780601f10612a0a57610100808354040283529160200191612a35565b820191906000526020600020905b815481529060010190602001808311612a1857829003601f168201915b505050505081565b600e546001600160a01b03163314612abd5760405162461bcd60e51b815260206004820152603e60248201527f4f6e6c792074686520666f72756d20636f6e74726163742063616e206d6f646960448201527f667920746f75726e616d656e74206d6f64657261746f722073746174757300006064820152608401610744565b6001600160a01b039091166000908152600960205260409020805491151563010000000263ff00000019909216919091179055565b600081604051602001612b05919061355d565b60408051808303601f19018152918152336000908152600360205220549091506001600160a01b03838116911614612b915760405162461bcd60e51b815260206004820152602960248201527f50726f706f73656420416e6f6e494420636f6e74726163742061646472657373604482015268040dad2e6dac2e8c6d60bb1b6064820152608401610744565b600085604051602001612ba491906136ee565b6040516020818303038152906040528051906020012090508060105403612c35576040805162461bcd60e51b81526020600482015260248101919091527f4c616d706f7274426173653a20504b48206d617463686573206c61737420757360448201527f656420504b482028757365207365706172617465207365636f6e64206b6579296064820152608401610744565b600f5460405163333f611160e01b81526000916001600160a01b03169063333f611190612c6c908a908a908a9089906004016135a3565b6020604051808303816000875af1158015612c8b573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612caf9190613684565b905080612cce5760405162461bcd60e51b815260040161074490613aae565b600c80546001600160a01b0319166001600160a01b0386169081179091556040517febc4468d0c46ed1b5177ed98bdb5d4ccfc7dd4f9da4caa02b6fd46b1e7be0d4e90600090a2505033600090815260036020526040812080546001600160a01b03191690556010555050505050565b33600090815260096020526040902054640100000000900460ff16612da55760405162461bcd60e51b815260206004820152601a60248201527f43616c6c6572206973206e6f7420612067616d652061646d696e0000000000006044820152606401610744565b60005b600854811015610aaa5781604051602001612dc391906138d1565b6040516020818303038152906040528051906020012060088281548110612dec57612dec6136a1565b90600052602060002001604051602001612e0691906138ed565b6040516020818303038152906040528051906020012003612ed95760008083604051612e3291906138d1565b908152604051908190036020019020805491151560ff1990921691909117905560088054612e62906001906136b7565b81548110612e7257612e726136a1565b9060005260206000200160088281548110612e8f57612e8f6136a1565b906000526020600020019081612ea59190613aef565b506008805480612eb757612eb76136d8565b600190038181906000526020600020016000612ed39190612ee1565b90555050565b600101612da8565b508054612eed9061378c565b6000825580601f10612efd575050565b601f016020900490600052602060002090810190612f1b9190612f1e565b50565b5b80821115612f335760008155600101612f1f565b5090565b80356001600160a01b0381168114612f4e57600080fd5b919050565b8015158114612f1b57600080fd5b60008060408385031215612f7457600080fd5b612f7d83612f37565b91506020830135612f8d81612f53565b809150509250929050565b806140008101831015611e6457600080fd5b806120008101831015611e6457600080fd5b6000806000806140608587031215612fd357600080fd5b612fdd8686612f98565b935061400085013567ffffffffffffffff811115612ffa57600080fd5b61300687828801612faa565b935050614020850135915061301e6140408601612f37565b905092959194509250565b60006020828403121561303b57600080fd5b61304482612f37565b9392505050565b60006020828403121561305d57600080fd5b5035919050565b6000806040838503121561307757600080fd5b61308083612f37565b946020939093013593505050565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff811182821017156130cd576130cd61308e565b604052919050565b600082601f8301126130e657600080fd5b813567ffffffffffffffff8111156131005761310061308e565b613113601f8201601f19166020016130a4565b81815284602083860101111561312857600080fd5b816020850160208301376000918101602001919091529392505050565b60008060008060008060c0878903121561315e57600080fd5b61316787612f37565b9550602087013567ffffffffffffffff8082111561318457600080fd5b6131908a838b016130d5565b965060408901359150808211156131a657600080fd5b506131b389828a016130d5565b94505060608701359250608087013591506131d060a08801612f37565b90509295509295509295565b6000602082840312156131ee57600080fd5b813567ffffffffffffffff81111561320557600080fd5b613211848285016130d5565b949350505050565b60005b8381101561323457818101518382015260200161321c565b50506000910152565b60008151808452613255816020860160208601613219565b601f01601f19169290920160200192915050565b8d151581528c151560208201528b1515604082015260006101a08c151560608401528b151560808401528a151560a084015289151560c08401528060e08401526132b58184018a61323d565b9050876101008401528281036101208401526132d1818861323d565b9150506132ea6101408301866001600160a01b03169052565b61016082019390935261018001529b9a5050505050505050505050565b600060208083016020845280855180835260408601915060408160051b87010192506020870160005b8281101561335e57603f1988860301845261334c85835161323d565b94509285019290850190600101613330565b5092979650505050505050565b6000806040838503121561337e57600080fd5b823567ffffffffffffffff8082111561339657600080fd5b818501915085601f8301126133aa57600080fd5b81356020828211156133be576133be61308e565b8160051b6133cd8282016130a4565b928352848101820192828101908a8511156133e757600080fd5b83870192505b84831015613423578235868111156134055760008081fd5b6134138c86838b01016130d5565b83525091830191908301906133ed565b9a9890920135985050505050505050565b6020808252825182820181905260009190848201906040850190845b818110156134755783516001600160a01b031683529284019291840191600101613450565b50909695505050505050565b6000806000806000614080868803121561349a57600080fd5b853567ffffffffffffffff808211156134b257600080fd5b6134be89838a016130d5565b9650602088013591506134d082612f53565b8195506134e08960408a01612f98565b94506140408801359150808211156134f757600080fd5b5061350488828901612faa565b9598949750929561406001359392505050565b602081526000613044602083018461323d565b6000806040838503121561353d57600080fd5b61354683612f37565b915061355460208401612f37565b90509250929050565b60609190911b6bffffffffffffffffffffffff1916815260140190565b81835281816020850137506000828201602090810191909152601f909101601f19169091010190565b60006140608281018388845b6101008110156135d0576040808385379283019291909101906001016135af565b50505061400084019190915261606083018660005b61010081101561365c5785830361405f190184528135368a9003601e1901811261360e57600080fd5b8901602081810191359067ffffffffffffffff82111561362d57600080fd5b81360383131561363c57600080fd5b61364786838561357a565b968101969550939093019250506001016135e5565b505085614020850152838103614040850152613678818661323d565b98975050505050505050565b60006020828403121561369657600080fd5b815161304481612f53565b634e487b7160e01b600052603260045260246000fd5b81810381811115611e6457634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052603160045260246000fd5b60008183825b610100811015613715576040808385379283019291909101906001016136f4565b5050506140008201905092915050565b60208082526041908201527f53616d6520504b48207573656420666f7220626f74682073746570733b20757360408201527f652061207365706172617465206b657920666f7220636f6e6669726d6174696f6060820152603760f91b608082015260a00190565b600181811c908216806137a057607f821691505b6020821081036119b357634e487b7160e01b600052602260045260246000fd5b601f82111561380c576000816000526020600020601f850160051c810160208610156137e95750805b601f850160051c820191505b81811015613808578281556001016137f5565b5050505b505050565b815167ffffffffffffffff81111561382b5761382b61308e565b61383f81613839845461378c565b846137c0565b602080601f831160018114613874576000841561385c5750858301515b600019600386901b1c1916600185901b178555613808565b600085815260208120601f198616915b828110156138a357888601518255948401946001909101908401613884565b50858210156138c15787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b600082516138e3818460208701613219565b9190910192915050565b60008083546138fb8161378c565b60018281168015613913576001811461392857613957565b60ff1984168752821515830287019450613957565b8760005260208060002060005b8581101561394e5781548a820152908401908201613935565b50505082870194505b50929695505050505050565b600081546139708161378c565b80855260206001838116801561398d57600181146139a7576139d5565b60ff1985168884015283151560051b8801830195506139d5565b866000528260002060005b858110156139cd5781548a82018601529083019084016139b2565b890184019650505b505050505092915050565b6040815260006139f36040830185613963565b905060018060a01b03831660208301529392505050565b600060208284031215613a1c57600080fd5b815160ff8116811461304457600080fd5b600082613a4a57634e487b7160e01b600052601260045260246000fd5b500490565b6001600160a01b038316815260406020820181905260009061321190830184613963565b600080600060608486031215613a8857600080fd5b835160038110613a9757600080fd5b602085015160409095015190969495509392505050565b60208082526021908201527f4c616d706f7274426173653a20417574686f72697a6174696f6e206661696c656040820152601960fa1b606082015260800190565b818103613afa575050565b613b04825461378c565b67ffffffffffffffff811115613b1c57613b1c61308e565b613b2a81613839845461378c565b6000601f821160018114613b5e5760008315613b465750848201545b600019600385901b1c1916600184901b178455613bc3565b600085815260209020601f19841690600086815260209020845b83811015613b985782860154825560019586019590910190602001613b78565b5085831015613bb65781850154600019600388901b60f8161c191681555b50505060018360011b0184555b505050505056fe4f6e6c7920746865206f6e72616d7020636f6e74726163742063616e20636861a2646970667358221220f04bc3d0837cc032e341802c4bdffc0d56039d8ea49f15e762aac29de1c229c364736f6c63430008180033"
#print(encoded_args.hex())
# Append the encoded arguments to the bytecode
#print(full_bytecode)
class LamportTest:
    
    def __init__(self):

        self.k1 = KeyTracker("master1") # new keys made here
        self.k2 = KeyTracker("master2")
        self.k3 = KeyTracker("oracle1")
        self.k4 = KeyTracker("master3")
        self.k5 = KeyTracker("master4")
        print("Initializing LamportTest...")
        with open('contract_AnonID.txt', 'r') as file:
            contract_address = file.read().strip()
        #print(contract_address)
        self.contract = AnonIDContract.at(contract_address)
        #lamport_base = LamportBase.at(contract_address) # <<< not working!
        accounts.default = str(accounts[0]) 
        # link it up
        pkhs = self.get_pkh_list(self.contract, 0)
        opkhs = self.get_pkh_list(self.contract, 1)
        # priv level set here with integer ^
        print("contract pkh", pkhs)

        self.load_four_masters(pkhs, "master")
        self.load_keys(opkhs, "oracle")
        print('init done')

    def get_pkh_list(self, contract, privilege_level):
        with open('contract_LamportBase2.txt', 'r') as file:
            contract_address = file.read().strip()
        contract2 = LamportBase2.at(contract_address)

        contract_pkh = str(contract2.getPKHsByPrivilege(privilege_level))
        # gonna need some kind of wait / delay here for primetime
        print(contract_pkh)
        contract_pkh_list = re.findall(r'0x[a-fA-F0-9]+', contract_pkh)
        pkh_list = [pkh for pkh in contract_pkh_list]  # Removing '0x' prefix
        contract_pkh_string = json.dumps(contract_pkh)
        contract_pkh_list = json.dumps(contract_pkh_string)
        return pkh_list

    
    def load_four_masters(self, pkhs, filename):
        pkh_index = 0
        master1_loaded = False
        master2_loaded = False
        master3_loaded = False
        master4_loaded = False
        global master_pkh_1
        global master_pkh_2
        global master_pkh_3
        global master_pkh_4

        while not master1_loaded and pkh_index < len(pkhs):
            try:
                self.k1.load(self, filename + '1', pkhs[pkh_index])
                print(f"Load successful for Master 1, PKH: {pkhs[pkh_index]}")
                master1_loaded = True
                key_tracker_1 = self.k1.current_key_pair()
                master_pkh_1 = pkhs[pkh_index]
                pkh_index += 1  # increment the pkh_index after successful load
            except InvalidAddress:
                print(f"No valid keys found for Master 1, PKH: {pkhs[pkh_index]}")
                pkh_index += 1  # increment the pkh_index if load failed

        if not master1_loaded:
            print("Load failed for all provided PKHs for Master 1")
            return

        while not master2_loaded and pkh_index < len(pkhs):
            try:
                self.k2.load(self, filename + '2', pkhs[pkh_index])
                print(f"Load successful for Master 2, PKH: {pkhs[pkh_index]}")
                master2_loaded = True
                key_tracker_2 = self.k2.current_key_pair()
                master_pkh_2 = pkhs[pkh_index]
                pkh_index += 1  # increment the pkh_index after successful load
            except InvalidAddress:
                print(f"No valid keys found for Master 2, PKH: {pkhs[pkh_index]}")
                pkh_index += 1  # increment the pkh_index if load failed

        if not master3_loaded:
            print("Load failed for all provided PKHs for Master 2")

        while not master3_loaded and pkh_index < len(pkhs):
            try:
                self.k4.load(self, filename + '3', pkhs[pkh_index])
                print(f"Load successful for Master 3, PKH: {pkhs[pkh_index]}")
                master3_loaded = True
                key_tracker_3 = self.k4.current_key_pair()
                master_pkh_3 = pkhs[pkh_index]
                pkh_index += 1  # increment the pkh_index after successful load
            except InvalidAddress:
                print(f"No valid keys found for Master 3, PKH: {pkhs[pkh_index]}")
                pkh_index += 1  # increment the pkh_index if load failed

        if not master4_loaded:
            print("Load failed for all provided PKHs for Master 2")

        while not master4_loaded and pkh_index < len(pkhs):
            try:
                self.k5.load(self, filename + '4', pkhs[pkh_index])
                print(f"Load successful for Master 3, PKH: {pkhs[pkh_index]}")
                master4_loaded = True
                key_tracker_4 = self.k5.current_key_pair()
                master_pkh_4 = pkhs[pkh_index]
                pkh_index += 1  # increment the pkh_index after successful load
            except InvalidAddress:
                print(f"No valid keys found for Master 3, PKH: {pkhs[pkh_index]}")
                pkh_index += 1  # increment the pkh_index if load failed

        if not master4_loaded:
            print("Load failed for all provided PKHs for Master 2")            

    def load_keys(self, pkhs, filename):
        global oracle_pkh
        for pkh in pkhs:
            try:
                oracle_pkh = pkh
                self.k3.load(self, filename + '1', pkh)
                print(f"Load successful for PKH: {pkh}")
                return  # Exit function after successful load
            except InvalidAddress:
                print(f"No valid keys found for PKH: {pkh}")
                continue  # Try the next pkh if this one fails
        print("Load failed for all provided PKHs")

    def can_test_key_functions(self, accs):
        global master_pkh_1
        global master_pkh_2
        global master_pkh_3
        global master_pkh_4
        print("Running 'can_test_key_functions'...")
        with open('contract_AnonID.txt', 'r') as file:
            contract_address = file.read()
            contract_address = contract_address.strip().replace('\n', '')  # Remove whitespace and newlines

        _contract = AnonIDContract.at(contract_address)
        print("Contract referenced.")
        print('master_pkh_3', master_pkh_3)
        private_key = '163f5f0f9a621d72fedd85ffca3d08d131ab4e812181e0d30ffd1c885d20aac7'
        brownie_account = accounts.add(private_key)
        current_keys = self.k4.load(self, "master3", master_pkh_3)
        current_pkh = self.k4.pkh_from_public_key(current_keys.pub)
        print('current pkh', current_pkh)
        next_keys = self.k4.get_next_key_pair()
        nextpkh = self.k4.pkh_from_public_key(next_keys.pub)
        #pairs = generate_address_value_pairs(10)
        #packed_pairs = solidity_pack_pairs(pairs)
        #_newCap = int(300000)
        #numToBroadcast = int(1000000)
        #pnumToBroadcast = numToBroadcast.to_bytes(4, 'big')
        #paddednumToBroadcast = solidity_pack_value_bytes(pnumToBroadcast)
        #paddressToBroadcast = '0x99a840C3BEEe41c3F5B682386f67277CfE3E3e29' # activity contract needing approval
        # with open('whitelist_contract.txt', 'r') as file:
        #     contract_address2 = file.read()
        #     contract_address2 = contract_address2.strip().replace('\n', '') 
        hashToBroadcast = Web3.keccak(hexstr=full_bytecode)
        print(hashToBroadcast.hex())
        packed_message = str.lower(hashToBroadcast.hex())[2:].encode() + nextpkh[2:].encode()
        print(packed_message)
        callhash = hash_b(str(packed_message.decode()))
        sig = sign_hash(callhash, current_keys.pri) 
        private_key = '163f5f0f9a621d72fedd85ffca3d08d131ab4e812181e0d30ffd1c885d20aac7'
        brownie_account = accounts.add(private_key)
        
        _contract.createContractStepOne(
            current_keys.pub,
            sig,
            nextpkh,
            hashToBroadcast,
            {'from': brownie_account, 'gas_limit': 3999999}    
        )
        self.k4.save(trim = False)
        #self.k4.save(trim = False)
        master_pkh_3 = nextpkh


        current_keys = self.k5.load(self, "master4", master_pkh_4)
        current_pkh = self.k5.pkh_from_public_key(current_keys.pub)
        print('current pkh', current_pkh)
        next_keys = self.k5.get_next_key_pair()
        nextpkh = self.k5.pkh_from_public_key(next_keys.pub)
        #pairs = generate_address_value_pairs(10)
        #packed_pairs = solidity_pack_pairs(pairs)
        #_newCap = int(300000)
        #numToBroadcast = int(1000000)
        #pnumToBroadcast = numToBroadcast.to_bytes(4, 'big')
        #paddednumToBroadcast = solidity_pack_value_bytes(pnumToBroadcast)
        #paddressToBroadcast = '0x99a840C3BEEe41c3F5B682386f67277CfE3E3e29' # activity contract needing approval
        # with open('whitelist_contract.txt', 'r') as file:
        #     contract_address2 = file.read()
        #     contract_address2 = contract_address2.strip().replace('\n', '') 
        hashToBroadcast = Web3.keccak(hexstr=full_bytecode)
        print(hashToBroadcast.hex())
        packed_message = str.lower(hashToBroadcast.hex())[2:].encode() + nextpkh[2:].encode()
        print(packed_message)
        callhash = hash_b(str(packed_message.decode()))
        sig = sign_hash(callhash, current_keys.pri) 
        private_key = '163f5f0f9a621d72fedd85ffca3d08d131ab4e812181e0d30ffd1c885d20aac7'
        brownie_account = accounts.add(private_key)
        
        _contract.createContractStepOne(
            current_keys.pub,
            sig,
            nextpkh,
            hashToBroadcast,
            {'from': brownie_account, 'gas_limit': 3999999}    
        )
        self.k5.save(trim = False)
        #self.k4.save(trim = False)
        master_pkh_4 = nextpkh

        #current_keys = self.k2.load(self, "master2", master_pkh_2)
        #next_keys = self.k2.get_next_key_pair()
        #nextpkh = self.k2.pkh_from_public_key(next_keys.pub)

        #paddressToBroadcast = '0xfd003CA44BbF4E9fB0b2fF1a33fc2F05A6C2EFF9'

        #packed_message = str.lower(full_bytecode)[2:].encode() + nextpkh[2:].encode()

        #callhash = hash_b(str(packed_message.decode()))
        #sig = sign_hash(callhash, current_keys.pri) 


        
        tx = _contract.createContractStepThree(

            full_bytecode,
            {'from': brownie_account, 'gas_limit': 3999999}    
        )
        tx.wait(1)

        # Extract the new contract address from the transaction's events
        new_contract_address = tx.events['ContractCreated']['contractAddress']

        print(f"New contract address: {new_contract_address}")
        #self.k2.save(trim = False)
        with open('contract_PlayerDatabase-coin.txt', 'w') as file:
            # Write the contract address to the file
            file.write(new_contract_address)
        exit()